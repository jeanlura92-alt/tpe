<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <title>CRM WhatsApp Artisans â€” Pipeline</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root{
      /* Palette identique Ã  lâ€™onglet Contacts */
      --bg:#0b1220;
      --panel:#0f172a;
      --sidebar-grad1:#4f46e5; /* indigo */
      --sidebar-grad2:#06b6d4; /* cyan */
      --card:#0b1324;
      --line:#1f2a44;
      --text:#e5e7eb;
      --muted:#94a3b8;
      --brand:#60a5fa;

      --badge-new:#22c55e;
      --badge-quote:#f59e0b;
      --badge-sched:#3b82f6;
      --badge-closed:#a855f7;

      --bubble-in:#0f172a;
      --bubble-out:#1e293b;
    }
    *{box-sizing:border-box}
    html,body{margin:0;padding:0;background:var(--bg);color:var(--text);font:14px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,"Helvetica Neue",Arial}
    a{color:inherit;text-decoration:none}

    /* Layout 3 colonnes : sidebar / kanban / conversation */
    .app{display:grid;grid-template-columns:260px 1fr 520px;min-height:100vh}

    /* Sidebar identique Ã  Contacts */
    .sidebar{
      background:linear-gradient(180deg,var(--sidebar-grad1) 0%,var(--sidebar-grad2) 100%);
      color:#fff; padding:18px 14px; position:sticky; top:0; height:100vh; overflow:auto
    }
    .brand{display:flex;align-items:center;gap:10px;margin-bottom:18px;font-weight:800;letter-spacing:.2px}
    .brand .dot{width:10px;height:10px;border-radius:50%;background:#fff;box-shadow:0 0 0 3px rgba(255,255,255,.25)}
    .side-title{opacity:.9;font-size:12px;text-transform:uppercase;letter-spacing:.08em;margin:0 0 8px}
    .nav a{
      display:flex;align-items:center;gap:8px;
      padding:10px 12px;border-radius:10px;margin-bottom:6px;
      background:rgba(255,255,255,.06); border:1px solid rgba(255,255,255,.12)
    }
    .nav a.active{background:rgba(255,255,255,.18)}
    .chips{display:flex;flex-wrap:wrap;gap:6px;margin-top:6px}
    .chips a{padding:6px 10px;border:1px solid rgba(255,255,255,.18);border-radius:999px;background:rgba(255,255,255,.08)}

    /* Kanban (zone centrale) */
    .center{padding:18px;border-right:1px solid var(--line)}
    .kanban{display:grid;gap:14px;grid-template-columns:repeat(4,minmax(240px,1fr))}
    .col{background:var(--panel);border:1px solid var(--line);border-radius:14px;overflow:hidden}
    .col-head{display:flex;align-items:center;justify-content:space-between;padding:10px 12px;border-bottom:1px solid var(--line);font-weight:700}
    .badge{font-size:11px;padding:4px 8px;border-radius:999px;opacity:.95;border:1px solid transparent}
    .b-new{color:var(--badge-new);background:rgba(34,197,94,.15);border-color:rgba(34,197,94,.25)}
    .b-quote{color:var(--badge-quote);background:rgba(245,158,11,.15);border-color:rgba(245,158,11,.25)}
    .b-sched{color:var(--badge-sched);background:rgba(59,130,246,.15);border-color:rgba(59,130,246,.25)}
    .b-closed{color:var(--badge-closed);background:rgba(168,85,247,.15);border-color:rgba(168,85,247,.25)}
    .card{margin:10px;padding:10px;border:1px solid var(--line);border-radius:12px;background:var(--card)}
    .deal-name{font-weight:700}
    .deal-meta{color:var(--muted);font-size:12px;margin-top:4px}
    .btn{display:inline-flex;align-items:center;gap:8px;padding:8px 10px;border-radius:10px;border:1px solid var(--line);cursor:pointer;background:var(--card);color:var(--text)}
    .btn-primary{background:var(--brand);border-color:var(--brand);color:#0b1220}

    /* Panneau droit (liste contacts + fil) */
    .right{display:flex;flex-direction:column;height:100vh;position:sticky;top:0}
    .right-head{background:var(--panel);border-bottom:1px solid var(--line);padding:12px 14px;display:flex;align-items:center;gap:10px}
    .chip{display:inline-flex;align-items:center;gap:6px;font-size:12px;padding:6px 8px;border-radius:999px;background:rgba(255,255,255,.08);border:1px solid rgba(255,255,255,.18)}
    .statusbar{background:var(--panel);border-bottom:1px solid var(--line);padding:10px 14px;display:flex;align-items:center;justify-content:space-between;gap:12px}
    .statusbar select{background:var(--card);border:1px solid var(--line);color:var(--text);padding:8px 10px;border-radius:8px}
    .right-body{display:grid;grid-template-columns:260px 1fr;height:100%;background:linear-gradient(180deg,#0b1220 0%,#0b1220 30%,#0d1630 100%)}

    /* Liste contacts â€” styles identiques Ã  Contacts */
    .contacts{border-right:1px solid var(--line);overflow:auto}
    .contacts .list{padding:10px}
    .contact{
      display:flex;align-items:center;justify-content:space-between;
      padding:10px;border-radius:10px;margin-bottom:6px;background:rgba(255,255,255,.03);border:1px solid var(--line)
    }
    .contact.active{background:rgba(96,165,250,.15);border-color:rgba(96,165,250,.35)}
    .contact .type{font-size:12px;color:var(--muted)}

    /* Fil de messages */
    .thread{display:flex;flex-direction:column;height:100%}
    .messages{flex:1;overflow:auto;padding:14px}
    .msg{display:flex;margin:8px 0}
    .msg.in{justify-content:flex-start}
    .msg.out{justify-content:flex-end}
    .bubble{max-width:70%;padding:10px 12px;border-radius:14px;border:1px solid var(--line);background:var(--bubble-in)}
    .msg.out .bubble{background:var(--bubble-out)}
    .bubble .meta{display:block;margin-top:6px;font-size:11px;color:var(--muted);text-align:right}
    .composer{border-top:1px solid var(--line);padding:12px;background:var(--panel);display:flex;gap:8px}
    .composer textarea{flex:1;padding:10px 12px;border-radius:10px;border:1px solid var(--line);background:var(--card);color:var(--text);resize:vertical;min-height:46px}
  </style>
</head>
<body>
  <div class="app">
    <!-- Sidebar (mÃªme que Contacts) -->
    <aside class="sidebar">
      <div class="brand"><span class="dot"></span><div>RDV-Pro â€¢ WhatsApp CRM</div></div>

      <div class="side-title">Navigation</div>
      <nav class="nav">
        <a class="active" href="/"><span>Pipeline WhatsApp</span></a>
        <a href="/contacts"><span>Contacts</span></a>
        <a href="/contacts/new"><span>+ Nouveau contact</span></a>
      </nav>

      <div class="side-title" style="margin-top:18px">Profils</div>
      <div class="chips">
        <a href="/">Tous</a>
        <a href="/?profile=client">Clients</a>
        <a href="/?profile=prospect">Prospects</a>
        <a href="/?profile=fournisseur">Fournisseurs</a>
        <a href="/?profile=autre">Autres</a>
      </div>
    </aside>

    <!-- Kanban -->
    <main class="center">
      <section class="kanban">
        {% for col in columns %}
          <div class="col">
            <div class="col-head">
              <span>{{ col.label }}</span>
              {% if col.id == 'new' %}
                <span class="badge b-new">{{ deals_by_status[col.id]|length }}</span>
              {% elif col.id == 'quote' %}
                <span class="badge b-quote">{{ deals_by_status[col.id]|length }}</span>
              {% elif col.id == 'scheduled' %}
                <span class="badge b-sched">{{ deals_by_status[col.id]|length }}</span>
              {% else %}
                <span class="badge b-closed">{{ deals_by_status[col.id]|length }}</span>
              {% endif %}
            </div>
            <div>
              {% for item in deals_by_status[col.id] %}
                <div class="card">
                  <div class="deal-name">{{ item.contact.name }}</div>
                  <div class="deal-meta">
                    {{ item.contact.phone }} â€¢ {{ item.deal.last_message_channel or 'â€”' }} â€¢
                    {{ item.deal.last_message_at.astimezone().strftime('%d/%m %H:%M') if item.deal.last_message_at else 'â€”' }}
                  </div>
                  <div style="margin-top:10px">
                    <a class="btn" href="/?contact_id={{ item.contact.id }}{% if current_profile and current_profile!='tous' %}&profile={{ current_profile }}{% endif %}">Ouvrir</a>
                  </div>
                </div>
              {% else %}
                <div class="deal-meta" style="padding:10px">Aucune affaire</div>
              {% endfor %}
            </div>
          </div>
        {% endfor %}
      </section>
    </main>

    <!-- Panneau droit (identique look & feel Contacts) -->
    <aside class="right">
      <div class="right-head">
        {% if selected %}
          <div style="font-weight:800">{{ selected.contact.name }}</div>
          <div class="chip">ðŸ“ž {{ selected.contact.phone }}</div>
        {% else %}
          <div class="chip">SÃ©lectionnez un contact</div>
        {% endif %}
      </div>

      <div class="statusbar">
        {% if selected %}
          <form method="post" action="/deals/{{ selected.deal.id }}/status">
            <input type="hidden" name="next" value="/?contact_id={{ selected.contact.id }}{% if current_profile and current_profile!='tous' %}&profile={{ current_profile }}{% endif %}">
            <select name="status" onchange="this.form.submit()">
              {% for val, label in status_options %}
                <option value="{{ val }}" {% if selected.deal.status==val %}selected{% endif %}>{{ label }}</option>
              {% endfor %}
            </select>
          </form>
        {% endif %}
        <div style="color:var(--muted);font-size:12px">Profil : <strong>{{ current_profile }}</strong></div>
      </div>

      <div class="right-body">
        <!-- Liste contacts (mÃªmes styles que lâ€™onglet Contacts) -->
        <div class="contacts">
          <div class="list">
            {% for c in contacts_list %}
              <a class="contact {% if selected and selected.contact.id==c.id %}active{% endif %}"
                 href="/?contact_id={{ c.id }}{% if current_profile and current_profile!='tous' %}&profile={{ current_profile }}{% endif %}">
                <span>{{ c.name }}</span>
                <span class="type">{{ c.type }}</span>
              </a>
            {% endfor %}
          </div>
        </div>

        <!-- Fil de messages (historique complet) -->
        <div class="thread">
          <div class="messages" id="messages">
            {% if messages %}
              {% for m in messages %}
                <div class="msg {{ 'out' if m.direction=='out' else 'in' }}">
                  <div class="bubble">
                    {{ m.content | e }}
                    <span class="meta">{{ (m.sent_at or m.created_at).astimezone().strftime('%d/%m %H:%M') }}</span>
                  </div>
                </div>
              {% endfor %}
            {% else %}
              <div class="deal-meta">Aucun message Ã  afficher.</div>
            {% endif %}
          </div>

          <div class="composer">
            {% if selected %}
              <form method="post" action="/deals/{{ selected.deal.id }}/send_message" style="display:flex;gap:8px;width:100%;">
                <textarea name="content" placeholder="Ã‰crire un message WhatsAppâ€¦"></textarea>
                <button class="btn btn-primary" type="submit">Envoyer</button>
              </form>
            {% else %}
              <div class="deal-meta">SÃ©lectionnez un contact pour Ã©crire.</div>
            {% endif %}
          </div>
        </div>
      </div>
    </aside>
  </div>

  <script>
    // Auto-scroll au bas de lâ€™historique
    (function(){ const el=document.getElementById('messages'); if(el) el.scrollTop=el.scrollHeight; })();
  </script>
</body>
</html>