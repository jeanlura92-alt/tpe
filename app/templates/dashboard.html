<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <title>CRM WhatsApp Artisans</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="/static/style.css">
  <style>
    /* Mini-ajouts pour le menu dans la carte */
    .deal { position: relative; padding-top: 26px; }
    .deal .inline-status {
      position: absolute; top: 6px; right: 6px; z-index: 2;
      display: inline-flex; align-items: center; gap: 4px;
      background: var(--card-bg, #fff); border: 1px solid rgba(0,0,0,.06);
      border-radius: 6px; padding: 2px 6px;
      box-shadow: 0 1px 2px rgba(0,0,0,.06);
      max-width: calc(100% - 12px);
    }
    .deal .inline-status label {
      font-size: 11px; color: var(--muted, #667085); white-space: nowrap;
    }
    .deal .inline-status select {
      font-size: 12px; border: none; background: transparent;
      padding: 2px 0; outline: none; max-width: 150px;
    }
    /* Empêche que le select déborde visuellement */
    .deal { overflow: hidden; }
  </style>
</head>
<body>
  <div class="container">
    <!-- Sidebar -->
    <aside class="card sidebar">
      <h3>Navigation</h3>
      <nav class="sidebar-nav">
        <a class="active" href="/"><span>Pipeline WhatsApp</span></a>
        <a href="/contacts"><span>Contacts</span></a>
        <a href="/contacts/new"><span>+ Nouveau contact</span></a>
      </nav>

      <div class="filter">
        <h3>Filtrer par profil</h3>
        <div style="display:flex; flex-wrap:wrap; gap:8px">
          <a class="btn" href="/?profile=client">Clients</a>
          <a class="btn" href="/?profile=prospect">Prospects</a>
          <a class="btn" href="/?profile=fournisseur">Fournisseurs</a>
          <a class="btn" href="/?profile=autre">Autres</a>
        </div>
      </div>
    </aside>

    <!-- Kanban (uniquement si profil choisi) -->
    <section class="kanban">
      {% if current_profile and current_profile in ['client','prospect','fournisseur','autre'] %}
        {% for col in columns %}
        <div class="card col" data-status="{{ col.id }}">
          <h4>{{ col.label }}</h4>
          <div class="dropzone" data-status="{{ col.id }}">
            {% for item in deals_by_status[col.id] %}
              <div class="deal" draggable="true" data-deal-id="{{ item.deal.id }}"
                   data-open-href="/?contact_id={{ item.contact.id }}&profile={{ current_profile }}">
                <!-- Menu déroulant inline pour changer de colonne -->
                <form class="inline-status" data-deal-id="{{ item.deal.id }}" onsubmit="return false;">
                  <label for="sel-{{ item.deal.id }}">Statut</label>
                  <select id="sel-{{ item.deal.id }}" class="inline-status-select" data-current="{{ item.deal.status }}">
                    {% for opt in columns %}
                      <option value="{{ opt.id }}" {% if item.deal.status == opt.id %}selected{% endif %}>{{ opt.label }}</option>
                    {% endfor %}
                  </select>
                </form>

                <div class="name">{{ item.contact.name }}</div>
                <div class="meta small muted">
                  {{ item.contact.phone }} • {{ item.deal.last_message_channel or '—' }} •
                  {{ item.deal.last_message_at.astimezone().strftime('%d/%m %H:%M') if item.deal.last_message_at else '—' }}
                </div>
              </div>
            {% else %}
              <div class="muted small" style="padding:6px 8px;">Aucune affaire</div>
            {% endfor %}
          </div>
        </div>
        {% endfor %}
      {% else %}
        <div class="card" style="grid-column:1 / -1;">
          <div class="empty">
            <div>
              <div style="font-weight:700; margin-bottom:6px;">Choisissez un profil pour afficher le Kanban</div>
              <div class="muted">Clients, Prospects, Fournisseurs ou Autres.</div>
            </div>
          </div>
        </div>
      {% endif %}
    </section>

    <!-- Right panel -->
    <aside class="card right">
      <div class="right-header">
        {% if selected %}
          <div style="font-weight:700">{{ selected.contact.name }}</div>
          <div class="muted">•</div>
          <div class="muted small">{{ selected.contact.phone }}</div>
        {% else %}
          <div class="muted">Clique une carte du kanban pour ouvrir le fil WhatsApp</div>
        {% endif %}
      </div>

      <!-- Toolbar SANS menu déroulant de statut -->
      <div class="toolbar">
        <div class="muted small">Profil : <strong>{{ current_profile or '—' }}</strong></div>
        <div class="muted small">
          {{ total_deals or 0 }} affaires • {{ total_contacts or 0 }} contacts
        </div>
      </div>

      <div class="right-body">
        <!-- === PANE : TOUS LES CONTACTS (pliant) === -->
        <div class="contacts-pane">
          <div class="section">
            <strong>Tous les contacts</strong>
            <div class="hint">Clique pour ouvrir le fil WhatsApp</div>
          </div>

          {% set contact_list = all_contacts or contacts or [] %}
          <details open>
            <summary>Liste ({{ contact_list|length }})</summary>
            <div class="search">
              <input id="contactSearch" type="text" placeholder="Rechercher… (nom, tel, email)">
            </div>
            <div id="contactsList" class="contacts-list">
              {% for c in contact_list %}
                <a class="contact-item {% if selected and selected.contact.id==c.id %}active{% endif %}"
                   href="/?contact_id={{ c.id }}{% if current_profile %}&profile={{ current_profile }}{% endif %}">
                  <div style="font-weight:600">{{ c.name }}</div>
                  <div class="contact-meta">
                    {{ c.type or '—' }} • {{ c.phone or '—' }} {% if c.email %}• {{ c.email }}{% endif %}
                  </div>
                </a>
              {% else %}
                <div class="muted small" style="padding:8px 12px;">Aucun contact</div>
              {% endfor %}
            </div>
          </details>
        </div>

        <!-- === PANE : THREAD WHATSAPP === -->
        <div class="thread">
          <div class="messages">
            {% if messages_next_cursor and selected %}
              <form method="get" style="margin-bottom:8px;">
                <input type="hidden" name="contact_id" value="{{ selected.contact.id }}">
                <input type="hidden" name="msgs_before" value="{{ messages_next_cursor }}">
                <input type="hidden" name="msgs_limit" value="{{ messages_limit }}">
                {% if current_profile %}<input type="hidden" name="profile" value="{{ current_profile }}">{% endif %}
                <button class="btn btn-ghost btn-full">Afficher plus d’historique</button>
              </form>
            {% endif %}

            {% if messages %}
              {% set last_day = None %}
              {% for m in messages %}
                {% set day = (m.sent_at or m.created_at).astimezone().strftime('%Y-%m-%d') %}
                {% if day != last_day %}
                  <div class="msg-divider">{{ (m.sent_at or m.created_at).astimezone().strftime('%d %b %Y') }}</div>
                  {% set last_day = day %}
                {% endif %}
                <div class="msg {{ 'out' if m.direction=='out' else 'in' }}">
                  <div class="bubble">
                    {{ m.content | e }}
                    <span class="meta">{{ (m.sent_at or m.created_at).astimezone().strftime('%H:%M') }}</span>
                  </div>
                </div>
              {% endfor %}
            {% else %}
              <div class="muted small">Aucun message à afficher.</div>
            {% endif %}
          </div>

          <div class="composer">
            {% if selected %}
            <form method="post" action="/deals/{{ selected.deal.id }}/send_message" style="display:flex; gap:8px; width:100%;">
              <textarea name="content" placeholder="Écrire un message WhatsApp…"></textarea>
              <button class="btn btn-primary" type="submit">Envoyer</button>
            </form>
            {% else %}
              <div class="muted">Sélectionne un contact pour écrire.</div>
            {% endif %}
          </div>
        </div>
      </div>
    </aside>
  </div>

  <script>
    // Drag & Drop + clic carte
    (function() {
      let draggedEl = null, didDrag = false;

      document.addEventListener("click", (e) => {
        const isSelect = e.target.closest(".inline-status-select");
        if (isSelect) return; // ne pas suivre le lien quand on utilise le select
        const card = e.target.closest(".deal[draggable='true']");
        if (!card) return;
        if (didDrag) { didDrag = false; return; }
        const href = card.dataset.openHref;
        if (href) window.location.assign(href);
      });

      document.addEventListener("dragstart", (e) => {
        const card = e.target.closest(".deal[draggable='true']");
        if (!card) return;
        draggedEl = card; didDrag = false;
        e.dataTransfer.setData("text/plain", card.dataset.dealId || "");
        e.dataTransfer.effectAllowed = "move";
        const img = document.createElement("canvas"); img.width = img.height = 1;
        e.dataTransfer.setDragImage(img,0,0);
      });
      document.addEventListener("drag", () => { if (draggedEl) didDrag = true; });
      document.addEventListener("dragend", () => { draggedEl = null; setTimeout(()=>didDrag=false,0); });

      const getZone = (el)=> el.closest(".dropzone, .col .dropzone");
      document.addEventListener("dragenter", (e)=>{ const z=getZone(e.target); if(!z) return; z.classList.add("dragover"); });
      document.addEventListener("dragover", (e)=>{ const z=getZone(e.target); if(!z) return; e.preventDefault(); e.dataTransfer.dropEffect="move"; });
      document.addEventListener("dragleave", (e)=>{ const z=getZone(e.target); if(!z) return; z.classList.remove("dragover"); });
      document.addEventListener("drop", async (e)=>{
        const zone=getZone(e.target); if(!zone) return; e.preventDefault(); zone.classList.remove("dragover");
        const dealId=(e.dataTransfer.getData("text/plain")||"").trim(); const newStatus=zone.dataset.status;
        if(!dealId || !newStatus) return;
        try{
          const form=new FormData(); form.append("status", newStatus);
          const resp=await fetch(`/deals/${dealId}/status`,{
            method:"POST",
            headers:{ "X-Requested-With":"XMLHttpRequest","Accept":"application/json" },
            body:form
          });
          let data=null; try{ data=await resp.json(); }catch(_){}
          if(resp.ok && data && data.ok){
            if(didDrag && draggedEl && zone!==draggedEl.parentElement){ zone.appendChild(draggedEl); flash(draggedEl); }
          }else{ alert("Impossible de changer d'étape."); }
        }catch(err){ alert("Erreur réseau : "+err); }
      });
      function flash(el){ el.style.outline="2px solid #86efac"; setTimeout(()=>{ el.style.outline="none"; },600); }
    })();

    // Changement de statut via menu déroulant intégré à la carte
    (function(){
      function moveCardDom(dealId, newStatus){
        const card = document.querySelector(`.deal[data-deal-id="${dealId}"]`);
        const dest = document.querySelector(`.dropzone[data-status="${newStatus}"]`);
        if(card && dest && card.parentElement!==dest){ dest.appendChild(card); }
      }
      document.addEventListener("change", async (e)=>{
        const sel = e.target.closest(".inline-status-select");
        if(!sel) return;
        e.stopPropagation();
        const form = sel.closest(".inline-status");
        const dealId = form?.dataset?.dealId;
        const newStatus = sel.value;
        if(!dealId || !newStatus) return;

        // POST AJAX
        try{
          const fd = new FormData(); fd.append("status", newStatus);
          const resp = await fetch(`/deals/${dealId}/status`, {
            method: "POST",
            headers: { "X-Requested-With": "XMLHttpRequest", "Accept": "application/json" },
            body: fd
          });
          let data=null; try{ data = await resp.json(); }catch(_){}
          if(resp.ok && data && data.ok){
            moveCardDom(dealId, newStatus);
          }else{
            alert("Mise à jour du statut impossible.");
            // Revenir sur l’option précédente
            sel.value = sel.dataset.current || sel.value;
          }
        }catch(err){
          alert("Erreur réseau : " + err);
          sel.value = sel.dataset.current || sel.value;
        }
      });

      // Empêche la propagation de clic pour ne pas ouvrir la fiche lors d’un tap sur le select
      document.addEventListener("mousedown", (e)=>{
        if(e.target.closest(".inline-status")) e.stopPropagation();
      });
      document.addEventListener("touchstart", (e)=>{
        if(e.target.closest(".inline-status")) e.stopPropagation();
      });
    })();

    // Filtre “Tous les contacts” (recherche locale)
    (function(){
      const input = document.getElementById('contactSearch');
      const list  = document.getElementById('contactsList');
      if(!input || !list) return;
      input.addEventListener('input', () => {
        const q = input.value.trim().toLowerCase();
        for(const a of list.querySelectorAll('.contact-item')){
          const txt = a.textContent.toLowerCase();
          a.style.display = txt.includes(q) ? '' : 'none';
        }
      });
    })();
  </script>
</body>
</html>