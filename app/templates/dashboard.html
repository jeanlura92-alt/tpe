<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <title>CRM WhatsApp Artisans â€” Pipeline</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root{
      /* ThÃ¨me clair (alignÃ© avec Contacts) */
      --bg:#f7f7fb;
      --panel:#ffffff;
      --sidebar:#ffffff;
      --line:#e5e7eb;
      --text:#0f172a;
      --muted:#6b7280;
      --brand:#2563eb;      /* bleu pro */
      --brand-weak:#e8f0ff; /* fond boutons/chips */
      --card:#ffffff;

      --badge-new:#16a34a;     /* vert */
      --badge-quote:#d97706;   /* orange */
      --badge-sched:#2563eb;   /* bleu */
      --badge-closed:#7c3aed;  /* violet */

      --bubble-in:#ffffff;
      --bubble-out:#eef2ff;
    }
    *{box-sizing:border-box}
    html,body{margin:0;padding:0;background:var(--bg);color:var(--text);font:14px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,"Helvetica Neue",Arial}
    a{color:inherit;text-decoration:none}

    /* Layout responsive: sidebar / kanban / conversation */
    .app{
      display:grid;
      grid-template-columns:260px 1fr 520px;
      min-height:100vh;
    }

    /* Header mobile (affichÃ© < 992px) */
    .topbar{
      display:none;
      position:sticky; top:0; z-index:20;
      background:var(--panel); border-bottom:1px solid var(--line);
      padding:10px 12px; align-items:center; justify-content:space-between;
    }
    .topbar .title{font-weight:700}
    .topbar .btn{padding:8px 10px;border:1px solid var(--line);border-radius:10px;background:#fff;cursor:pointer}

    /* Sidebar claire */
    .sidebar{
      background:var(--sidebar); color:var(--text);
      padding:18px 14px; position:sticky; top:0; height:100vh; overflow:auto;
      border-right:1px solid var(--line);
    }
    .brand{display:flex;align-items:center;gap:10px;margin-bottom:18px;font-weight:800;letter-spacing:.2px}
    .brand .dot{width:10px;height:10px;border-radius:50%;background:var(--brand);box-shadow:0 0 0 3px rgba(37,99,235,.15)}
    .side-title{font-size:12px;color:var(--muted);text-transform:uppercase;letter-spacing:.08em;margin:0 0 8px}
    .nav a{
      display:flex;align-items:center;gap:8px;
      padding:10px 12px;border-radius:10px;margin-bottom:6px;
      background:#fff; border:1px solid var(--line);
    }
    .nav a.active{background:var(--brand-weak); border-color:#cfe0ff}
    .chips{display:flex;flex-wrap:wrap;gap:6px;margin-top:6px}
    .chips a{padding:6px 10px;border:1px solid var(--line);border-radius:999px;background:#fff}
    .chips a.active{background:var(--brand-weak); border-color:#cfe0ff}

    /* Kanban (zone centrale) */
    .center{padding:18px;border-right:1px solid var(--line); background:var(--bg)}
    .kanban{display:grid;gap:14px;grid-template-columns:repeat(4,minmax(240px,1fr))}
    .col{background:var(--panel);border:1px solid var(--line);border-radius:14px;overflow:hidden}
    .col-head{display:flex;align-items:center;justify-content:space-between;padding:10px 12px;border-bottom:1px solid var(--line);font-weight:700}
    .badge{font-size:11px;padding:4px 8px;border-radius:999px;opacity:.95;border:1px solid transparent}
    .b-new{color:var(--badge-new);background:rgba(22,163,74,.10);border-color:rgba(22,163,74,.25)}
    .b-quote{color:var(--badge-quote);background:rgba(217,119,6,.10);border-color:rgba(217,119,6,.25)}
    .b-sched{color:var(--badge-sched);background:rgba(37,99,235,.10);border-color:rgba(37,99,235,.25)}
    .b-closed{color:var(--badge-closed);background:rgba(124,58,237,.10);border-color:rgba(124,58,237,.25)}
    .card{margin:10px;padding:10px;border:1px solid var(--line);border-radius:12px;background:var(--card)}
    .deal-name{font-weight:700}
    .deal-meta{color:var(--muted);font-size:12px;margin-top:4px}
    .btn{display:inline-flex;align-items:center;gap:8px;padding:8px 10px;border-radius:10px;border:1px solid var(--line);cursor:pointer;background:#fff;color:var(--text)}
    .btn-primary{background:var(--brand);border-color:var(--brand);color:#fff}

    /* Panneau droit (liste contacts + fil) */
    .right{display:flex;flex-direction:column;height:100vh;position:sticky;top:0;background:var(--panel)}
    .right-head{background:var(--panel);border-bottom:1px solid var(--line);padding:12px 14px;display:flex;align-items:center;gap:10px}
    .chip{display:inline-flex;align-items:center;gap:6px;font-size:12px;padding:6px 8px;border-radius:999px;background:var(--brand-weak);border:1px solid #cfe0ff}
    .statusbar{background:var(--panel);border-bottom:1px solid var(--line);padding:10px 14px;display:flex;align-items:center;justify-content:space-between;gap:12px}
    .statusbar select{background:#fff;border:1px solid var(--line);color:var(--text);padding:8px 10px;border-radius:8px}
    .right-body{display:grid;grid-template-columns:260px 1fr;height:100%;background:#fff}

    /* Liste contacts */
    .contacts{border-right:1px solid var(--line);overflow:auto;background:#fff}
    .contacts .list{padding:10px}
    .contact{
      display:flex;align-items:center;justify-content:space-between;
      padding:10px;border-radius:10px;margin-bottom:6px;background:#fff;border:1px solid var(--line)
    }
    .contact.active{background:var(--brand-weak);border-color:#cfe0ff}
    .contact .type{font-size:12px;color:var(--muted)}

    /* Fil messages */
    .thread{display:flex;flex-direction:column;height:100%;background:#fff}
    .messages{flex:1;overflow:auto;padding:14px;background:#fafafa;border-bottom:1px solid var(--line)}
    .msg{display:flex;margin:8px 0}
    .msg.in{justify-content:flex-start}
    .msg.out{justify-content:flex-end}
    .bubble{max-width:70%;padding:10px 12px;border-radius:14px;border:1px solid var(--line);background:var(--bubble-in)}
    .msg.out .bubble{background:var(--bubble-out)}
    .bubble .meta{display:block;margin-top:6px;font-size:11px;color:var(--muted);text-align:right}
    .composer{border-top:1px solid var(--line);padding:12px;background:#fff;display:flex;gap:8px}
    .composer textarea{flex:1;padding:10px 12px;border-radius:10px;border:1px solid var(--line);background:#fff;color:var(--text);resize:vertical;min-height:46px}

    /* --- Responsive --- */
    @media (max-width: 1200px){
      .app{grid-template-columns:220px 1fr 460px}
      .right-body{grid-template-columns:220px 1fr}
    }
    @media (max-width: 992px){
      .topbar{display:flex}
      .app{grid-template-columns:1fr}
      .sidebar{display:none;position:fixed;inset:0 35% 0 0;z-index:30;box-shadow:4px 0 20px rgba(0,0,0,.15)}
      .sidebar.open{display:block}
      .center{order:2;border-right:none;border-bottom:1px solid var(--line)}
      .right{order:3;height:auto;position:static}
      .right-body{grid-template-columns:1fr}
      .contacts{border-right:none;border-bottom:1px solid var(--line)}
    }
    @media (max-width: 640px){
      .kanban{grid-template-columns:1fr}    /* Kanban 1 colonne */
      .messages{padding:10px}
      .bubble{max-width:85%}
    }
  </style>
</head>
<body>
  <!-- Topbar mobile -->
  <div class="topbar">
    <div class="title">Pipeline WhatsApp</div>
    <button class="btn" onclick="toggleSidebar()">Menu</button>
  </div>

  <div class="app">
    <!-- Sidebar claire -->
    <aside class="sidebar" id="sidebar">
      <div class="brand"><span class="dot"></span><div>RDV-Pro â€¢ WhatsApp CRM</div></div>

      <div class="side-title">Navigation</div>
      <nav class="nav">
        <a class="active" href="/"><span>Pipeline WhatsApp</span></a>
        <a href="/contacts"><span>Contacts</span></a>
        <a href="/contacts/new"><span>+ Nouveau contact</span></a>
      </nav>

      <div class="side-title" style="margin-top:18px">Profils</div>
      <div class="chips">
        <a href="/" class="{{ 'active' if current_profile=='tous' else '' }}">Tous</a>
        <a href="/?profile=client" class="{{ 'active' if current_profile=='client' else '' }}">Clients</a>
        <a href="/?profile=prospect" class="{{ 'active' if current_profile=='prospect' else '' }}">Prospects</a>
        <a href="/?profile=fournisseur" class="{{ 'active' if current_profile=='fournisseur' else '' }}">Fournisseurs</a>
        <a href="/?profile=autre" class="{{ 'active' if current_profile=='autre' else '' }}">Autres</a>
      </div>
    </aside>

    <!-- Kanban -->
    <main class="center">
      <section class="kanban">
        {% for col in columns %}
          <div class="col">
            <div class="col-head">
              <span>{{ col.label }}</span>
              {% if col.id == 'new' %}
                <span class="badge b-new">{{ deals_by_status[col.id]|length }}</span>
              {% elif col.id == 'quote' %}
                <span class="badge b-quote">{{ deals_by_status[col.id]|length }}</span>
              {% elif col.id == 'scheduled' %}
                <span class="badge b-sched">{{ deals_by_status[col.id]|length }}</span>
              {% else %}
                <span class="badge b-closed">{{ deals_by_status[col.id]|length }}</span>
              {% endif %}
            </div>
            <div>
              {% for item in deals_by_status[col.id] %}
                <div class="card">
                  <div class="deal-name">{{ item.contact.name }}</div>
                  <div class="deal-meta">
                    {{ item.contact.phone }} â€¢ {{ item.deal.last_message_channel or 'â€”' }} â€¢
                    {{ item.deal.last_message_at.astimezone().strftime('%d/%m %H:%M') if item.deal.last_message_at else 'â€”' }}
                  </div>
                  <div style="margin-top:10px">
                    <a class="btn" href="/?contact_id={{ item.contact.id }}{% if current_profile and current_profile!='tous' %}&profile={{ current_profile }}{% endif %}">Ouvrir</a>
                  </div>
                </div>
              {% else %}
                <div class="deal-meta" style="padding:10px">Aucune affaire</div>
              {% endfor %}
            </div>
          </div>
        {% endfor %}
      </section>
    </main>

    <!-- Panneau droit -->
    <aside class="right">
      <div class="right-head">
        {% if selected %}
          <div style="font-weight:800">{{ selected.contact.name }}</div>
          <div class="chip">ðŸ“ž {{ selected.contact.phone }}</div>
        {% else %}
          <div class="chip">SÃ©lectionnez un contact</div>
        {% endif %}
      </div>

      <div class="statusbar">
        {% if selected %}
          <form method="post" action="/deals/{{ selected.deal.id }}/status">
            <input type="hidden" name="next" value="/?contact_id={{ selected.contact.id }}{% if current_profile and current_profile!='tous' %}&profile={{ current_profile }}{% endif %}">
            <select name="status" onchange="this.form.submit()">
              {% for val, label in status_options %}
                <option value="{{ val }}" {% if selected.deal.status==val %}selected{% endif %}>{{ label }}</option>
              {% endfor %}
            </select>
          </form>
        {% endif %}
        <div style="color:var(--muted);font-size:12px">Profil : <strong>{{ current_profile }}</strong></div>
      </div>

      <div class="right-body">
        <!-- Liste contacts -->
        <div class="contacts">
          <div class="list">
            {% for c in contacts_list %}
              <a class="contact {% if selected and selected.contact.id==c.id %}active{% endif %}"
                 href="/?contact_id={{ c.id }}{% if current_profile and current_profile!='tous' %}&profile={{ current_profile }}{% endif %}">
                <span>{{ c.name }}</span>
                <span class="type">{{ c.type }}</span>
              </a>
            {% endfor %}
          </div>
        </div>

        <!-- Fil de messages (historique complet) -->
        <div class="thread">
          <div class="messages" id="messages">
            {% if messages %}
              {% for m in messages %}
                <div class="msg {{ 'out' if m.direction=='out' else 'in' }}">
                  <div class="bubble">
                    {{ m.content | e }}
                    <span class="meta">{{ (m.sent_at or m.created_at).astimezone().strftime('%d/%m %H:%M') }}</span>
                  </div>
                </div>
              {% endfor %}
            {% else %}
              <div class="deal-meta">Aucun message Ã  afficher.</div>
            {% endif %}
          </div>

          <div class="composer">
            {% if selected %}
              <form method="post" action="/deals/{{ selected.deal.id }}/send_message" style="display:flex;gap:8px;width:100%;">
                <textarea name="content" placeholder="Ã‰crire un message WhatsAppâ€¦"></textarea>
                <button class="btn btn-primary" type="submit">Envoyer</button>
              </form>
            {% else %}
              <div class="deal-meta">SÃ©lectionnez un contact pour Ã©crire.</div>
            {% endif %}
          </div>
        </div>
      </div>
    </aside>
  </div>

  <script>
    function toggleSidebar(){
      var sb = document.getElementById('sidebar');
      if(!sb) return;
      if(sb.classList.contains('open')) sb.classList.remove('open');
      else sb.classList.add('open');
    }
    // Auto-scroll au bas de lâ€™historique
    (function(){ const el=document.getElementById('messages'); if(el) el.scrollTop=el.scrollHeight; })();
  </script>
</body>
</html>