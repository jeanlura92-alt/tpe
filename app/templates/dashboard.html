
{% block title %}Pipeline WhatsApp{% endblock %}

{% block content %}
<style>
  .kanban {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
    gap: 12px;
  }
  .column {
    background: #f8fafc;
    border: 1px solid #e5e7eb;
    border-radius: 10px;
    padding: 10px;
    min-height: 220px;
  }
  .column h3 {
    margin: 0 0 8px;
    font-size: 14px;
    font-weight: 600;
    color: #374151;
    display: flex; justify-content: space-between; align-items: center;
  }
  .cards { display: flex; flex-direction: column; gap: 8px; }

  .card {
    background: #ffffff;
    border: 1px solid #e5e7eb;
    border-radius: 10px;
    padding: 10px;
    cursor: grab;
  }
  .card:active { cursor: grabbing; }
  .card h4 { margin: 0 0 6px; font-size: 14px; color: #111827; }
  .card .meta { font-size: 12px; color: #6b7280; margin-bottom: 6px; }

  /* select compact qui ne déborde pas */
  .status-row { display: flex; gap: 8px; align-items: center; justify-content: space-between; }
  .status-select {
    max-width: 150px; width: 100%;
    font-size: 12px; padding: 4px 6px;
    border: 1px solid #d1d5db; border-radius: 8px; background: #fff;
    white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
  }

  /* panneau contacts à droite */
  .aside {
    border-left: 1px solid #e5e7eb;
    padding-left: 12px;
  }
  details.contacts-panel summary {
    cursor: pointer; list-style: none; font-weight: 600; color: #111827;
  }
  details.contacts-panel[open] summary { color: #111827; }
  .contact-list { margin-top: 8px; max-height: 60vh; overflow:auto; }
  .contact-item { padding: 6px 8px; border-bottom: 1px solid #f3f4f6; display: flex; justify-content: space-between; align-items: center; }
  .contact-item a { font-size: 13px; color: #111827; text-decoration: none; }
  .contact-item small { color: #6b7280; }

  .board-wrap {
    display: grid;
    grid-template-columns: 1fr 320px;
    gap: 16px;
  }

  @media (max-width: 1024px) {
    .board-wrap { grid-template-columns: 1fr; }
    .aside { border-left: none; padding-left: 0; }
  }
</style>

<div class="board-wrap">
  <div>
    <form method="get" action="/" style="margin-bottom:10px; display:flex; gap:8px; align-items:center;">
      <label for="profile">Profil :</label>
      <select name="profile" id="profile" onchange="this.form.submit()">
        <option value="" {% if not current_profile %}selected{% endif %} disabled>— choisir —</option>
        <option value="client" {% if current_profile=='client' %}selected{% endif %}>Client</option>
        <option value="prospect" {% if current_profile=='prospect' %}selected{% endif %}>Prospect</option>
        <option value="fournisseur" {% if current_profile=='fournisseur' %}selected{% endif %}>Fournisseur</option>
        <option value="autre" {% if current_profile=='autre' %}selected{% endif %}>Autre</option>
      </select>
    </form>

    {% if current_profile %}
      <div class="kanban" id="kanban">
        {% for col in columns %}
          <div class="column" data-status="{{ col.id }}">
            <h3>{{ col.label }}</h3>
            <div class="cards" ondragover="event.preventDefault();" ondrop="onDrop(event, '{{ col.id }}')">
              {% for row in deals_by_status[col.id] %}
                {% set d = row.deal %}
                {% set c = row.contact %}
                <div class="card" draggable="true" ondragstart="onDragStart(event)" data-deal-id="{{ d.id }}">
                  <h4>{{ c.name or 'Sans nom' }}</h4>
                  <div class="meta">
                    {{ c.phone or '' }}{% if c.company %} • {{ c.company }}{% endif %}
                  </div>

                  <div class="status-row">
                    <small>Statut :</small>
                    <select class="status-select" onchange="changeStatusSelect({{ d.id }}, this.value)">
                      {% for opt in columns %}
                        <option value="{{ opt.id }}" {% if d.status==opt.id %}selected{% endif %}>{{ opt.label }}</option>
                      {% endfor %}
                    </select>
                  </div>
                </div>
              {% endfor %}
            </div>
          </div>
        {% endfor %}
      </div>
    {% else %}
      <p>Choisissez un profil pour afficher le Kanban.</p>
    {% endif %}
  </div>

  <aside class="aside">
    <details class="contacts-panel" open>
      <summary>Tous les contacts ({{ contacts|length }})</summary>
      <div class="contact-list">
        {% for ct in contacts %}
          <div class="contact-item">
            <a href="/?contact_id={{ ct.id }}{% if current_profile %}&profile={{ current_profile }}{% endif %}">{{ ct.name or 'Sans nom' }}</a>
            <small>{{ ct.type or '-' }}</small>
          </div>
        {% endfor %}
      </div>
    </details>

    {% if selected %}
      <hr style="margin:12px 0;">
      <h4>Conversation avec {{ selected.contact.name }}</h4>
      <div id="thread" style="border:1px solid #e5e7eb; border-radius:8px; padding:8px; max-height:40vh; overflow:auto;">
        {% for m in messages %}
          <div style="margin-bottom:8px;">
            <small style="color:#6b7280;">{{ m.created_at }}</small><br>
            <span><strong>{{ '↖' if m.direction=='in' else '↘' }} {{ m.direction }}</strong> — {{ m.content }}</span>
          </div>
        {% endfor %}
      </div>

      <form id="send-form" method="post" action="/deals/{{ selected.deal.id }}/send_message" onsubmit="return sendMessage(event)" style="margin-top:8px;">
        <textarea name="content" rows="2" placeholder="Écrire un message…" style="width:100%;"></textarea>
        <button type="submit">Envoyer</button>
      </form>
    {% endif %}
  </aside>
</div>

<script>
  // Drag & drop
  function onDragStart(ev){
    ev.dataTransfer.setData("dealId", ev.target.closest(".card").dataset.dealId);
  }
  function onDrop(ev, newStatus){
    ev.preventDefault();
    const dealId = ev.dataTransfer.getData("dealId");
    if(!dealId) return;
    const fd = new FormData();
    fd.append("status", newStatus);
    fetch(`/deals/${dealId}/status`, { method: "POST", body: fd })
      .then(r => r.json())
      .then(res => {
        if(res.ok){
          // déplacer la carte dans la colonne cible
          const card = document.querySelector(`.card[data-deal-id="${dealId}"]`);
          const col = document.querySelector(`.column[data-status="${newStatus}"] .cards`);
          if(card && col){ col.appendChild(card); }
          // sync aussi le select
          const sel = card.querySelector(".status-select");
          if(sel){ sel.value = newStatus; }
        }
      });
  }

  // Menu déroulant statut (par carte)
  function changeStatusSelect(dealId, statusVal){
    const fd = new FormData();
    fd.append("status", statusVal);
    fetch(`/deals/${dealId}/status`, { method: "POST", body: fd })
      .then(r => r.json())
      .then(res => {
        if(res.ok){
          // déplacer la carte
          const card = document.querySelector(`.card[data-deal-id="${dealId}"]`);
          const col = document.querySelector(`.column[data-status="${statusVal}"] .cards`);
          if(card && col){ col.appendChild(card); }
        }
      });
  }

  // Envoi message sans reload
  function sendMessage(e){
    e.preventDefault();
    const form = e.target;
    const url = form.action;
    const fd = new FormData(form);
    fetch(url, { method: "POST", body: fd })
      .then(r => r.json())
      .then(res => {
        if(res.ok){
          const ta = form.querySelector('textarea[name="content"]');
          if(ta && ta.value.trim()){
            const thread = document.getElementById("thread");
            const now = new Date().toISOString();
            const div = document.createElement("div");
            div.style.marginBottom = "8px";
            div.innerHTML = `<small style="color:#6b7280;">${now}</small><br><span><strong>↘ out</strong> — ${escapeHtml(ta.value)}</span>`;
            thread.appendChild(div);
            thread.scrollTop = thread.scrollHeight;
            ta.value = "";
          }
        }
      });
    return false;
  }

  function escapeHtml(s){
    return s.replace(/[&<>"']/g, function(m){
      return ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;'})[m];
    });
  }
</script>
{% endblock %}
