{% extends "base.html" %}
{% block title %}CRM WhatsApp Artisans - Pipeline{% endblock %}

{% block extra_head %}
<style>
  /* Styles principaux : pipeline et chat */
  .panel-header { display: flex; justify-content: space-between; align-items: center; gap: 12px; margin-bottom: 8px; }
  .panel-title-block { display: flex; flex-direction: column; gap: 4px; }
  .panel-title { font-size: 15px; font-weight: 600; display: flex; align-items: center; gap: 8px; }
  .badge { font-size: 11px; padding: 1px 8px; border-radius: 999px; background: var(--accent-soft); color: var(--accent-strong); border: 1px solid #bfdbfe; }
  .panel-subtitle { font-size: 12px; color: var(--text-soft); }
  .panel-filters { display: flex; align-items: center; gap: 8px; flex-wrap: wrap; }
  .input, .select { border-radius: 999px; border: 1px solid var(--border); padding: 6px 10px; font-size: 12px; background: #ffffff; color: var(--text); min-width: 0; }

  .kanban { margin-top: 8px; display: grid; grid-template-columns: repeat(4, minmax(0, 1fr)); gap: 10px; overflow-x: auto; }
  .kanban-column { background: var(--bg-soft-2); border-radius: 10px; border: 1px solid var(--border); padding: 10px; display: flex; flex-direction: column; min-width: 220px; }

  .card { border-radius: 10px; border: 1px solid var(--border); padding: 8px; background: #ffffff; transition: 0.15s; cursor: pointer; }
  .card:hover { border-color: var(--accent-soft); box-shadow: 0 1px 4px rgba(15,23,42,0.08); }
  .card.active { border-color: var(--accent); background: #eff6ff; }

  .sidepanel-item.active { border-color: var(--accent); background: var(--accent-soft); }
</style>
{% endblock %}

{% block content %}
<main class="main-content">
  <!-- PIPELINE -->
  <section class="panel">
    <div class="panel-header">
      <div class="panel-title-block">
        <div class="panel-title">Pipeline WhatsApp <span class="badge">Artisans</span></div>
        <div class="panel-subtitle">Demandes clients et fournisseurs classées par étape.</div>
      </div>
    </div>

    <div class="kanban">
      {% for col in columns %}
      {% set deals = deals_by_status.get(col.id, []) %}
      <div class="kanban-column">
        <div class="kanban-column-title">{{ col.label }} ({{ deals|length }})</div>
        {% for item in deals %}
        {% set deal = item.deal %}
        {% set contact = item.contact %}
        <a href="/?contact_id={{ contact.id }}" style="text-decoration:none;">
          <div class="card {% if selected and selected.contact.id == contact.id %}active{% endif %}">
            <div class="card-title" style="font-weight:500;">{{ contact.name }}</div>
            <div style="font-size:12px;color:var(--text-soft);">{{ deal.title }}</div>
            <div style="font-size:11px;color:var(--accent-strong);">{{ deal.amount_estimated or "—" }} €</div>
          </div>
        </a>
        {% else %}
        <div style="font-size:12px;color:var(--text-soft);">Aucun dossier.</div>
        {% endfor %}
      </div>
      {% endfor %}
    </div>
  </section>

  <!-- CHAT PANEL -->
  <section class="panel">
    {% if selected %}
      {% set s_deal = selected.deal %}
      {% set s_contact = selected.contact %}
    {% endif %}

    <header class="chat-header">
      <div class="chat-contact">
        <div class="avatar">{{ s_contact.name[0] | upper if selected else '?' }}</div>
        <div>
          <div style="font-weight:600;">{{ s_contact.name if selected else "Aucun contact sélectionné" }}</div>
          <div style="font-size:12px;color:var(--text-soft);">{{ s_contact.phone if selected else "Sélectionnez un contact à gauche" }}</div>
        </div>
      </div>
    </header>

    <div class="chat-body">
      <div style="flex:1;padding:10px;border:1px solid var(--border);border-radius:8px;background:#fafafa;">
        {% if selected %}
          <div style="font-size:13px;color:var(--text);margin-bottom:8px;">Chat avec {{ s_contact.name }}</div>
          <div style="font-size:12px;color:var(--text-soft);">Dernier message : {{ s_deal.last_message_preview or "—" }}</div>
        {% else %}
          <div style="font-size:12px;color:var(--text-soft);">Clique sur un contact pour afficher la conversation.</div>
        {% endif %}
      </div>
    </div>

    <div class="chat-input-wrapper" style="margin-top:10px;">
      <form method="post" action="/deals/{{ s_deal.id if selected else 0 }}/send_message">
        <input name="content" class="chat-input" placeholder="Envoyer un message WhatsApp..." style="width:100%;padding:8px;border:1px solid var(--border);border-radius:999px;" />
        <div style="margin-top:6px;text-align:right;">
          <button class="btn btn-primary">Envoyer</button>
        </div>
      </form>
    </div>

    <!-- LISTE TOUS LES CONTACTS -->
    <div class="chat-sidepanel" style="margin-top:14px;">
      <div class="sidepanel-title" style="font-size:12px;text-transform:uppercase;color:var(--text-soft);margin-bottom:4px;">Tous les contacts</div>
      {% for c in contacts_list %}
      <a href="/?contact_id={{ c.id }}" style="text-decoration:none;">
        <div class="sidepanel-item {% if selected and selected.contact.id == c.id %}active{% endif %}">
          <strong>{{ c.name }}</strong><br>
          <span style="font-size:11px;color:var(--text-soft);">{{ c.phone }}</span><br>
          <span class="sidepanel-tag" style="font-size:10px;">{{ c.type|capitalize }}</span>
        </div>
      </a>
      {% else %}
      <div style="font-size:12px;color:var(--text-soft);">Aucun contact encore.</div>
      {% endfor %}
    </div>
  </section>
</main>
{% endblock %}
